<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>easySQL - Migración de Datos Simplificada</title>
    <link rel="stylesheet" href="styles/landing.css">
    <link rel="stylesheet" href="styles/landing-animations.css">
    <link rel="stylesheet" href="styles/modals-landing.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="scripts/packEasysql.js"></script>
    <script type="module" src="scripts/unpackEasysql.js"></script>
</head>
<body>
    <div class="background-container">
        <div class="gradient-bg"></div>
        <div class="floating-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
            <div class="shape shape-4"></div>
            <div class="shape shape-5"></div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <h1>easySQL</h1>
                <span class="tagline">Data Migration Made Simple</span>
            </div>
            <nav class="nav">
                <button class="nav-btn active" data-tab="overview">Inicio</button>
                <button class="nav-btn" data-tab="getting-started">¿Cómo empezar?</button>
                <a href="easySQL.html" class="access-btn">Acceder a la App</a>
            </nav>
        </header>

        <main class="main-content">
            <!-- Overview Tab -->
            <section id="overview" class="tab-content active">
                <div class="hero-section">
                    <div class="hero-content">
                        <h2 class="hero-title">
                            Transforma el <span class="highlight">caos de datos</span> 
                            en bases de datos <span class="highlight">organizadas</span>
                        </h2>
                        <p class="hero-description">
                            easySQL es la solución definitiva para migrar los datos caóticos que se acumulan 
                            en tu empresa a lo largo de los años hacia bases de datos estructuradas, 
                            consultables y fáciles de usar.
                        </p>
                        <div class="cta-buttons">
                            <button class="cta-primary" onclick="showTab('getting-started')">
                                Comenzar Migración
                            </button>
                            <button class="cta-secondary" onclick="openLoginModal()">
                                Probar Demo
                            </button>
                        </div>
                    </div>
                    <div class="hero-visual">
                        <div class="data-transformation">
                            <div class="chaos-data">
                                <div class="file-icon">📄</div>
                                <div class="file-icon">📊</div>
                                <div class="file-icon">📋</div>
                                <div class="file-icon">💾</div>
                            </div>
                            <div class="arrow">→</div>
                            <div class="organized-data">
                                <div class="database-icon">🗄️</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="features-section">
                    <h3 class="section-title">¿Por qué elegir easySQL?</h3>
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">🔄</div>
                            <h4>Migración Inteligente</h4>
                            <p>Convertimos tus datos dispersos en Excel, CSV, documentos y sistemas legacy en bases de datos SQL estructuradas.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🔍</div>
                            <h4>Búsqueda Simplificada</h4>
                            <p>Encuentra información específica en segundos con nuestras herramientas de búsqueda intuitivas.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🎨</div>
                            <h4>Interfaz Intuitiva</h4>
                            <p>No necesitas ser programador. Nuestra interfaz está diseñada para cualquier usuario de empresa.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🔒</div>
                            <h4>Seguridad Total</h4>
                            <p>Tus datos se entregan en un archivo comprimido y cifrado que solo tú puedes acceder.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">📈</div>
                            <h4>Escalabilidad</h4>
                            <p>Tu base de datos crece contigo. Añade nuevos datos y tablas sin perder la organización.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🤖</div>
                            <h4>IA Integrada</h4>
                            <p>Consulta tus datos en lenguaje natural usando nuestra integración con inteligencia artificial.</p>
                        </div>
                    </div>
                </div>

                <div class="process-section">
                    <h3 class="section-title">El Resultado Final</h3>
                    <div class="result-card">
                        <div class="result-content">
                            <h4>Tu Paquete de Datos Completo</h4>
                            <p>Al finalizar el proceso, recibirás un archivo comprimido y cifrado que incluye:</p>
                            <ul class="result-list">
                                <li>🗄️ Tablas SQL estructuradas con todos tus datos</li>
                                <li>📊 Datos extraídos y limpiados</li>
                                <li>📎 Archivos referenciados organizados</li>
                                <li>🎨 Logo y personalización de tu empresa</li>
                                <li>🤖 Configuración de API para IA</li>
                                <li>⚙️ Archivos de personalización</li>
                            </ul>
                            <p class="result-highlight">
                                <strong>Acceso universal:</strong> Desde cualquier lugar del mundo, 
                                podrás acceder de forma segura para consultar, editar, insertar datos 
                                y hacer crecer tu empresa de manera <em>easy</em>.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Getting Started Tab -->
            <section id="getting-started" class="tab-content">
                <div class="getting-started-hero">
                    <h2 class="hero-title">
                        Empezar es <span class="highlight">easy</span>
                    </h2>
                    <p class="hero-description">
                        Elige el camino que mejor se adapte a tus necesidades y recursos.
                    </p>
                </div>

                <div class="paths-section">
                    <div class="path-option">
                        <div class="path-header">
                            <div class="path-icon">🛠️</div>
                            <h3>Opción 1: Hazlo Tú Mismo</h3>
                            <span class="path-badge">Recomendado para equipos técnicos</span>
                        </div>
                        <div class="path-content">
                            <p>
                                Obtén acceso completo a nuestra aplicación y migra tus datos 
                                usando nuestras herramientas intuitivas.
                            </p>
                            <div class="path-features">
                                <div class="path-feature">
                                    <span class="feature-check">✓</span>
                                    <span>Acceso completo a la plataforma</span>
                                </div>
                                <div class="path-feature">
                                    <span class="feature-check">✓</span>
                                    <span>Herramientas de migración guiadas</span>
                                </div>
                                <div class="path-feature">
                                    <span class="feature-check">✓</span>
                                    <span>Soporte técnico incluido</span>
                                </div>
                                <div class="path-feature">
                                    <span class="feature-check">✓</span>
                                    <span>Control total sobre el proceso</span>
                                </div>
                            </div>
                            <div class="path-note">
                                <strong>Nivel requerido:</strong> No es muy complejo, pero puede requerir 
                                ciertos conocimientos básicos de bases de datos.
                            </div>
                            <button type="button" class="path-button primary" onclick="openLoginModal()">
                                Acceder a la Aplicación
                            </button>
                        </div>
                    </div>

                    <div class="path-option">
                        <div class="path-header">
                            <div class="path-icon">👥</div>
                            <h3>Opción 2: Lo Hacemos Nosotros</h3>
                            <span class="path-badge">Recomendado para empresas</span>
                        </div>
                        <div class="path-content">
                            <p>
                                Nuestro equipo de expertos se encarga de migrar todos tus datos 
                                mientras tú te enfocas en tu negocio.
                            </p>
                            <div class="path-features">
                                <div class="path-feature">
                                    <span class="feature-check">✓</span>
                                    <span>Migración completa por expertos</span>
                                </div>
                                <div class="path-feature">
                                    <span class="feature-check">✓</span>
                                    <span>Análisis de datos incluido</span>
                                </div>
                                <div class="path-feature">
                                    <span class="feature-check">✓</span>
                                    <span>Personalización avanzada</span>
                                </div>
                                <div class="path-feature">
                                    <span class="feature-check">✓</span>
                                    <span>Capacitación del equipo</span>
                                </div>
                            </div>
                            <div class="path-note">
                                <strong>Perfecto para:</strong> Empresas que quieren resultados 
                                profesionales sin invertir tiempo interno en el proceso.
                            </div>
                            <button class="path-button secondary" onclick="openContactModal()">
                                Contactar con Nosotros
                            </button>
                        </div>
                    </div>
                </div>

                <div class="guarantee-section">
                    <div class="guarantee-card">
                        <h4>🎯 Garantía de Resultado</h4>
                        <p>
                            Independientemente del camino que elijas, obtendrás el mismo resultado final: 
                            un archivo comprimido y cifrado con toda tu información organizada y lista para usar.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Gestor easySQL -->
            <section id="esql-manager" class="tab-content esql-manager" style="display:none;">
                <h2 class="hero-title" style="font-size:2.2rem; margin-bottom:2rem;">
                    Gestor <span class="highlight">easySQL</span>
                </h2>
                <div class="esql-grid">
                    <div class="esql-card">
                        <h4>Datos de la Empresa</h4>
                        <small>Información básica</small>
                        <input id="empresaNombre" type="text" placeholder="Nombre de la empresa" maxlength="120">
                        <textarea id="empresaDescripcion" placeholder="Descripción (máx 500 carácteres)" maxlength="500"></textarea>
                        <div class="char-counter" id="descCounter">0 / 500</div>
                        <input id="logoFile" type="file" accept="image/png">
                        <div class="warning-note" style="margin-top:.85rem;">
                            El logo debe ser .png. La descripción se incluirá en el archivo .bsql.
                        </div>
                    </div>
                    <div class="esql-card" id="devCard">
                        <h4>Desarrolladores</h4>
                        <span class="badge-limit" id="devLimitBadge">0 / 3</span>
                        <small>Máx 3 usuarios</small>
                        <div class="role-list" id="devList"></div>
                        <button id="addDevBtn" class="add-btn" type="button">+ Añadir Dev</button>
                    </div>
                    <div class="esql-card" id="adminCard">
                        <h4>Administradores</h4>
                        <span class="badge-limit" id="adminLimitBadge">0 / 10</span>
                        <small>Máx 10 usuarios</small>
                        <div class="role-list" id="adminList"></div>
                        <button id="addAdminBtn" class="add-btn" type="button">+ Añadir Admin</button>
                    </div>
                    <div class="esql-card">
                        <h4>Estado de Archivos</h4>
                        <small>Fuentes de datos</small>
                        <div class="inline-flags">
                            <label><input type="checkbox" id="chkTablas" disabled> Tablas SQL recibidas</label>
                            <label><input type="checkbox" id="chkInserciones" disabled> Inserciones SQL recibidas</label>
                        </div>
                        <div class="warning-note" style="margin-top:1rem;">
                            Al acceder por licencia inicial todavía no has cargado archivos
                            de tablas ni inserciones. Podrás añadirlos más adelante.
                        </div>
                        <h4 style="margin-top:1.75rem;">Contraseña Maestra</h4>
                        <small>Cifrado del paquete</small>
                        <div class="master-pass">
                            <input id="masterPass" type="password" placeholder="Contraseña / Frase secreta">
                            <input id="masterPass2" type="password" placeholder="Repite la contraseña">
                            <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
                            <div class="strength-text" id="strengthText">Fuerza: -</div>
                            <div class="warning-note">
                                Mínimo 8 caracteres. Recomendada frase fácil de recordar con
                                números y caracteres especiales. Anótala en un lugar seguro
                                (no se puede recuperar).
                            </div>
                        </div>
                        <div class="download-area">
                            <button id="generateBtn" class="generate-btn" type="button" disabled>
                                Crear Archivo easySQL
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>&copy; 2024 easySQL. Transformando datos, simplificando empresas.</p>
        </footer>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Contacta con Nosotros</h3>
                <button class="modal-close" onclick="closeContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="contact-content">
                    <h4>🚀 ¡Hablemos de tu proyecto!</h4>
                    <p>
                        Nuestro equipo de expertos está listo para ayudarte con la migración 
                        de tus datos. Cuéntanos sobre tu proyecto y te proporcionaremos una 
                        solución personalizada.
                    </p>
                    <p>
                        Haz clic en el botón de abajo para enviar un correo directamente 
                        a nuestro equipo técnico.
                    </p>
                    <a href="mailto:easysql.team@gmail.com?subject=Consulta sobre migración de datos&body=Hola equipo de easySQL,%0D%0A%0D%0AEstoy interesado/a en sus servicios de migración de datos.%0D%0A%0D%0AMi empresa: %0D%0ATipo de datos: %0D%0AVolumen aproximado: %0D%0A%0D%0AGracias!" 
                       class="email-button">
                        <span class="email-icon">📧</span>
                        Enviar Correo Electrónico
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content login-modal">
            <div class="modal-header login-header">
                <h3>Acceso a easySQL</h3>
                <button class="modal-close" onclick="closeLoginModal()">×</button>
            </div>
            <div class="modal-body login-body">
                
                <div class="login-container">
                    <div class="login-options" id="loginOptions">
                        <!-- Left Option: Upload File -->
                        <div class="login-option">
                            <div class="option-icon">
                                <div class="file-upload-icon">📁</div>
                            </div>
                            <h4>Cargar Archivo eSQL</h4>
                            <p>Si ya tienes un archivo eSQL de un proyecto anterior, súbelo para continuar trabajando.</p>
                            <!-- Navigation Button for Left Option -->
                            <button class="navigation-button nav-left" id="navLeft" onclick="showFileUpload()">￫</button>
                        </div>

                        <!-- Right Option: New User -->
                        <div class="login-option">
                            <div class="option-icon">
                                <div class="new-user-icon">👤</div>
                            </div>
                            <h4>Nuevo Usuario</h4>
                            <p>Comienza desde cero y crea tu primera base de datos con nuestras herramientas.</p>
                            <!-- Navigation Button for Right Option -->
                            <button class="navigation-button nav-right" id="navRight" onclick="showNewUser()">￩</button>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="divider" id="divider"></div>

                    <!-- Step Content for File Upload -->
                    <div class="step-content left" id="fileUploadStep">
                        <h4>Subir Archivo eSQL</h4>
                        
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('esqlFileInput').click()">
                            <div class="upload-content">
                                <div class="upload-icon">📁</div>
                                <span>Seleccionar archivo .easySQL</span>
                            </div>
                            <input type="file" id="esqlFileInput" accept=".easysql" style="display: none;">
                        </div>
                        
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <span class="file-name"></span>
                            <button class="remove-file" onclick="removeFile()">✕</button>
                        </div>
                        
                        <button class="step-button" id="uploadBtn" disabled onclick="handleEsqlLogin()">
                            Acceder con Archivo
                        </button>
                    </div>

                    <!-- Step Content for New User -->
                    <div class="step-content right" id="newUserStep">
                        <h4>Clave de Licencia</h4>
                        <p>Introduce tu clave de licencia para comenzar</p>
                        
                        <input type="text" class="license-input" id="licenseKey" placeholder="Clave de licencia">
                        <div id="licenseError" class="license-error" style="min-height:14px;font-size:.65rem;color:#ff8080;margin-top:.4rem;"></div>
                        
                        <button id="licenseBtn" class="step-button" onclick="handleNewUserLogin()">
                            Empezar como Nuevo Usuario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="packOverlay" style="display:none;position:fixed;inset:0;backdrop-filter:blur(8px);background:rgba(0,0,0,.55);z-index:2000;align-items:center;justify-content:center;">
        <div style="width:min(420px,90%);background:rgba(0,20,40,.85);border:1px solid rgba(0,204,255,.3);padding:2rem 2.2rem;border-radius:22px;font-family:inherit;color:#fff;box-shadow:0 10px 40px rgba(0,0,0,.4);">
            <h3 style="margin:0 0 1rem;font-size:1.15rem;letter-spacing:.5px;display:flex;align-items:center;gap:.6rem;">
                <span style="font-size:1.4rem;">🔐</span> Generando archivo cifrado
            </h3>
            <p id="packStatus" style="margin:.25rem 0 1.2rem;font-size:.8rem;letter-spacing:.5px;color:rgba(255,255,255,.7);">Preparando...</p>
            <div style="height:10px;background:rgba(255,255,255,.1);border-radius:6px;overflow:hidden;position:relative;margin-bottom:.9rem;">
                <div id="packBar" style="height:100%;width:0;background:linear-gradient(90deg,#0066ff,#00ccff,#00ffbb);background-size:200% 100%;animation:shift 2.5s linear infinite;"></div>
            </div>
            <style>@keyframes shift{0%{background-position:0 0}100%{background-position:200% 0}}</style>
            <button id="cancelPackBtn" type="button" style="margin-top:.5rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#fff;padding:.55rem 1rem;font-size:.7rem;border-radius:8px;cursor:not-allowed;opacity:.5;">Cancelar (no disponible)</button>
        </div>
    </div>

    <script>
        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Event listeners for nav buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                showTab(tabName);
            });
        });

        // Modal functionality
        function openContactModal() {
            document.getElementById('contactModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeContactModal() {
            document.getElementById('contactModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Login Modal functionality
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            resetLoginModal();
        }

        // Login animation functionality
        let currentStep = 'none';

        function showFileUpload() {
            const loginOptions = document.getElementById('loginOptions');
            const fileUploadStep = document.getElementById('fileUploadStep');
            const newUserStep = document.getElementById('newUserStep');
            const navLeft = document.getElementById('navLeft');
            const navRight = document.getElementById('navRight');
            const divider = document.getElementById('divider');
            
            // Hide divider and right button
            divider.style.opacity = '0';
            navRight.style.opacity = '0';
            navRight.style.pointerEvents = 'none';
            
            // Slide right to show left content (content moves right, left option stays)
            loginOptions.classList.add('slide-right');
            
            // Change left button direction and function
            navLeft.innerHTML = '￩'; // was ←
            navLeft.onclick = goBack;
            
            setTimeout(() => {
                fileUploadStep.classList.add('active');
                newUserStep.classList.remove('active');
                currentStep = 'file';
            }, 400);
        }

        function showNewUser() {
            const loginOptions = document.getElementById('loginOptions');
            const fileUploadStep = document.getElementById('fileUploadStep');
            const newUserStep = document.getElementById('newUserStep');
            const navLeft = document.getElementById('navLeft');
            const navRight = document.getElementById('navRight');
            const divider = document.getElementById('divider');
            
            // Hide divider and left button
            divider.style.opacity = '0';
            navLeft.style.opacity = '0';
            navLeft.style.pointerEvents = 'none';
            
            // Slide left to show right content (content moves left, right option stays)
            loginOptions.classList.add('slide-left');
            
            // Change right button direction and function
            navRight.innerHTML = '￫'; // was →
            navRight.onclick = goBack;
            
            setTimeout(() => {
                newUserStep.classList.add('active');
                fileUploadStep.classList.remove('active');
                currentStep = 'user';
            }, 400);
        }

        function goBack() {
            const loginOptions = document.getElementById('loginOptions');
            const fileUploadStep = document.getElementById('fileUploadStep');
            const newUserStep = document.getElementById('newUserStep');
            const navLeft = document.getElementById('navLeft');
            const navRight = document.getElementById('navRight');
            const divider = document.getElementById('divider');
            
            // Hide step content
            fileUploadStep.classList.remove('active');
            newUserStep.classList.remove('active');
            
            // Reset navigation buttons
            navLeft.innerHTML = '￫';  // reset
            navLeft.onclick = showFileUpload;
            navRight.innerHTML = '￩'; // reset
            navRight.onclick = showNewUser;
            
            setTimeout(() => {
                // Reset slide position
                loginOptions.classList.remove('slide-left', 'slide-right');
                
                // Show divider and buttons
                divider.style.opacity = '1';
                navLeft.style.opacity = '1';
                navRight.style.opacity = '1';
                navLeft.style.pointerEvents = 'auto';
                navRight.style.pointerEvents = 'auto';
                
                currentStep = 'none';
            }, 200);
        }

        function resetLoginModal() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInfo = document.getElementById('fileInfo');
            
            document.getElementById('esqlFileInput').value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block'; // Make sure upload area is visible
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('licenseKey').value = ''; // limpiamos (antes '000000')
            document.getElementById('licenseError').textContent = '';
            
            // Reset all states
            const loginOptions = document.getElementById('loginOptions');
            const fileUploadStep = document.getElementById('fileUploadStep');
            const newUserStep = document.getElementById('newUserStep');
            const navLeft = document.getElementById('navLeft');
            const navRight = document.getElementById('navRight');
            const divider = document.getElementById('divider');
            
            loginOptions.classList.remove('slide-left', 'slide-right');
            fileUploadStep.classList.remove('active');
            newUserStep.classList.remove('active');
            
            navLeft.innerHTML = '￫';
            navRight.innerHTML = '￩';
            navLeft.onclick = showFileUpload;
            navRight.onclick = showNewUser;
            
            divider.style.opacity = '1';
            navLeft.style.opacity = '1';
            navRight.style.opacity = '1';
            navLeft.style.pointerEvents = 'auto';
            navRight.style.pointerEvents = 'auto';
            
            currentStep = 'none';
        }

        // File upload handling
        document.getElementById('esqlFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const uploadArea = document.getElementById('uploadArea');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = fileInfo.querySelector('.file-name');
                const uploadBtn = document.getElementById('uploadBtn');
                
                // Hide upload area and show file info
                uploadArea.style.display = 'none';
                fileName.textContent = file.name;
                fileInfo.style.display = 'flex';
                uploadBtn.disabled = false;
            }
        });

        function removeFile() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInfo = document.getElementById('fileInfo');
            const uploadBtn = document.getElementById('uploadBtn');
            
            // Clear file input
            document.getElementById('esqlFileInput').value = '';
            
            // Show upload area and hide file info
            uploadArea.style.display = 'block';
            fileInfo.style.display = 'none';
            uploadBtn.disabled = true;
        }

        // Update the demo button event
        document.addEventListener('DOMContentLoaded', function() {
            // Update any existing demo button events
            const demoButtons = document.querySelectorAll('.cta-secondary');
            demoButtons.forEach(button => {
                if (button.textContent.includes('Demo')) {
                    button.onclick = openLoginModal;
                }
            });
        });

        // Update the access button to open login modal instead
        document.querySelector('.access-btn').addEventListener('click', function(e) {
            e.preventDefault();
            openLoginModal();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const contactModal = document.getElementById('contactModal');
            const loginModal = document.getElementById('loginModal');
            if (event.target === contactModal) {
                closeContactModal();
            }
            if (event.target === loginModal) {
                closeLoginModal();
            }
        }

        // Prevent body scrolling when modal is open
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            resetLoginModal();
        }

        function openContactModal() {
            document.getElementById('contactModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeContactModal() {
            document.getElementById('contactModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Form submission (proteger si no existe el formulario)
        const contactForm = document.querySelector('.contact-form');
        if (contactForm) {
            contactForm.addEventListener('submit', function(e) {
                e.preventDefault();
                alert('¡Gracias por tu interés! Nos pondremos en contacto contigo pronto.');
                closeContactModal();
            });
        }

        // Añadir handlers de descripción
        const descEl = document.getElementById('empresaDescripcion');
        const counter = document.getElementById('descCounter');
        descEl?.addEventListener('input', () => {
            counter.textContent = `${descEl.value.length} / 500`;
        });

        // Gestión roles
        const devList = document.getElementById('devList');
        const adminList = document.getElementById('adminList');
        const devLimitBadge = document.getElementById('devLimitBadge');
        const adminLimitBadge = document.getElementById('adminLimitBadge');
        const addDevBtn = document.getElementById('addDevBtn');
        const addAdminBtn = document.getElementById('addAdminBtn');

        function updateBadges() {
            devLimitBadge.textContent = `${devList.children.length} / 3`;
            adminLimitBadge.textContent = `${adminList.children.length} / 10`;
            addDevBtn.disabled = devList.children.length >= 3;
            addAdminBtn.disabled = adminList.children.length >= 10;
        }
        function makeRow(listEl) {
            const row = document.createElement('div');
            row.className = 'role-row';
            row.innerHTML = `
                <input type="text" placeholder="usuario" maxlength="32">
                <input type="password" placeholder="contraseña" maxlength="64">
                <button type="button" title="Eliminar">✕</button>
            `;
            row.querySelector('button').onclick = () => { row.remove(); updateBadges(); validateGenerate(); };
            listEl.appendChild(row);
            updateBadges();
        }
        addDevBtn?.addEventListener('click', ()=>{ makeRow(devList); validateGenerate(); });
        addAdminBtn?.addEventListener('click', ()=>{ makeRow(adminList); validateGenerate(); });

        // Password strength
        const master1 = document.getElementById('masterPass');
        const master2 = document.getElementById('masterPass2');
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        function scorePass(p) {
            let score = 0;
            if (p.length >= 8) score+=15;
            if (p.length >= 12) score+=10;
            if (p.length >= 16) score+=10;
            if (/[a-z]/.test(p)) score+=15;
            if (/[A-Z]/.test(p)) score+=15;
            if (/\d/.test(p)) score+=15;
            if (/[^A-Za-z0-9]/.test(p)) score+=20;
            if (/\s/.test(p) && p.length >= 16) score+=10; // frase con espacios
            return Math.min(score,100);
        }
        function renderStrength() {
            const v = master1.value;
            const s = scorePass(v);
            strengthFill.style.width = s + '%';
            let level = 'Débil';
            if (s >= 80) level = 'Muy Fuerte';
            else if (s >= 60) level = 'Fuerte';
            else if (s >= 40) level = 'Media';
            strengthText.textContent = `Fuerza: ${level} (${s}%)`;
            validateGenerate();
        }
        master1?.addEventListener('input', renderStrength);
        master2?.addEventListener('input', validateGenerate);

        // Validación para habilitar botón generar
        const empresaNombre = document.getElementById('empresaNombre');
        const logoFile = document.getElementById('logoFile');
        const generateBtn = document.getElementById('generateBtn');
        [empresaNombre, logoFile].forEach(el=> el?.addEventListener('input', validateGenerate));
        logoFile?.addEventListener('change', validateGenerate);

        function validateGenerate() {
            const nameOk = empresaNombre.value.trim().length > 0;
            const logoOk = logoFile.files.length === 1 && /\.png$/i.test(logoFile.files[0].name);
            const passOk = master1.value.length >= 8 && master1.value === master2.value;
            // Usuarios: validar formatos (no vacío si existe)
            let usersOk = true;
            [...devList.children, ...adminList.children].forEach(r=>{
                const inputs = r.querySelectorAll('input');
                if (![...inputs].every(i=> i.value.trim().length>0)) usersOk=false;
            });
            generateBtn.disabled = !(nameOk && logoOk && passOk && usersOk);
        }

        // Construcción archivos
        function buildAcceso(devs, admins) {
            let out = '*dev\n';
            devs.forEach(d=>{
                out += '-' + d.user + '\n';
                out += '+' + d.pass + '\n';
            });
            out += '*admin\n';
            admins.forEach(a=>{
                out += '-' + a.user + '\n';
                out += '+' + a.pass + '\n';
            });
            out += '*consultor\n';
            return out;
        }
        function buildEmpresa(nombre, descripcion) {
            return `*nombre\n${nombre}\n*descripcion\n${descripcion}\n`;
        }

        // Helper: esperar a que packEasysqlWeb esté listo
        function ensurePackEasysqlReady() {
            if (typeof packEasysqlWeb === 'function') return Promise.resolve();
            return new Promise(resolve => {
                window.addEventListener('packEasysqlReady', () => resolve(), { once: true });
            });
        }

        const overlay = document.getElementById('packOverlay');
        const packBar = document.getElementById('packBar');
        const packStatus = document.getElementById('packStatus');

        function showOverlay() {
            overlay.style.display = 'flex';
            packBar.style.width = '0%';
            packStatus.textContent = 'Preparando archivos...';
        }
        function hideOverlay() {
            overlay.style.display = 'none';
        }
        function updateProgress(p) {
            const pct = Math.round(p * 100);
            packBar.style.width = pct + '%';
            if (pct < 60) packStatus.textContent = 'Empaquetando (' + pct + '%)...';
            else if (pct < 80) packStatus.textContent = 'Derivando clave segura...';
            else if (pct < 93) packStatus.textContent = 'Cifrando contenido...';
            else if (pct < 100) packStatus.textContent = 'Finalizando...';
            else packStatus.textContent = 'Completado';
        }

        async function generatePackage() {
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generando...';
            showOverlay();
            try {
                await ensurePackEasysqlReady();
                const devs = [...devList.children].map(r=>{
                    const [u,p] = r.querySelectorAll('input');
                    return {user:u.value.trim(), pass:p.value};
                });
                const admins = [...adminList.children].map(r=>{
                    const [u,p] = r.querySelectorAll('input');
                    return {user:u.value.trim(), pass:p.value};
                });
                const acceso = buildAcceso(devs, admins);
                const empresa = buildEmpresa(empresaNombre.value.trim(), document.getElementById('empresaDescripcion').value.trim());
                const logo = logoFile.files[0];

                const files = [
                    {name:'ACCESO.asql', blob: new Blob([acceso], {type:'text/plain'})},
                    {name:'EMPRESA.bsql', blob: new Blob([empresa], {type:'text/plain'})},
                    {name: logo?.name?.endsWith('.png') ? logo.name : 'logo.png', blob: logo}
                ];
                const blob = await packEasysqlWeb(files, master1.value, updateProgress);
                updateProgress(1);
                const a = document.createElement('a');
                a.download = (empresaNombre.value.trim().replace(/\s+/g,'_') || 'easySQL') + '.easysql';
                a.href = URL.createObjectURL(blob);
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(a.href);
                a.remove();
            } catch (e) {
                alert('Error al generar: ' + e.message);
            } finally {
                generateBtn.textContent = 'Crear Archivo easySQL';
                hideOverlay();
                validateGenerate();
            }
        }
        // Reemplazar anterior listener (si ya existía)
        generateBtn?.removeEventListener('click', generatePackage);
        generateBtn?.addEventListener('click', generatePackage);

        // Nuevo handler usando licenseService (carga perezosa)
        window.handleNewUserLogin = async function() {
            const input = document.getElementById('licenseKey');
            const errEl = document.getElementById('licenseError');
            const btn = document.getElementById('licenseBtn');
            const code = (input.value || '').trim();
            errEl.textContent = '';
            input.classList.remove('error');

            if (!code) {
                errEl.textContent = 'Introduce una clave.';
                input.classList.add('error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Verificando...';

            try {
                const { validarLicencia, marcarLicenciaUsada } = await import('./scripts/licenseService.js');
                const res = await validarLicencia(code);

                if (res.exists && res.usable) {
                    // Acceso inmediato
                    closeLoginModal();
                    document.querySelectorAll('.tab-content').forEach(t=> t.classList.remove('active'));
                    const mgr = document.getElementById('esql-manager');
                    mgr.style.display = 'block';
                    mgr.classList.add('active');
                    devList.innerHTML = '';
                    adminList.innerHTML = '';
                    updateBadges();
                    renderStrength();
                    counter.textContent = '0 / 500';
                    // Marcar usada (no bloquea UI si falla)
                    marcarLicenciaUsada(res.ref);
                } else {
                    errEl.textContent = res.exists ? 'Licencia ya usada.' : 'Licencia inexistente.';
                    input.classList.add('error');
                }
            } catch (e) {
                if (e.code === 'permission-denied') {
                    // Lectura denegada: tratamos como no válida (mostrar mensaje genérico)
                    errEl.textContent = 'Permisos Firestore denegados (revisa reglas).';
                } else {
                    errEl.textContent = 'Error validando: ' + (e.message || e);
                }
                input.classList.add('error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Empezar como Nuevo Usuario';
            }
        };

        // Quitar estado error al cambiar la clave
        document.getElementById('licenseKey')?.addEventListener('input', e=>{
            e.target.classList.remove('error');
            const err = document.getElementById('licenseError');
            if (err) err.textContent = '';
        });

        // Close modals on escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeContactModal();
                closeLoginModal();
            }
        });

        // Prevent default form submission
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
            });
        });
    </script>
</body>
</html>