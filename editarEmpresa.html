<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>easySQL - Editar Empresa</title>
<link rel="stylesheet" href="styles/landing.css">
<link rel="stylesheet" href="styles/landing-animations.css">
<link rel="stylesheet" href="styles/modals-landing.css">
<script type="module" src="scripts/packEasysql.js"></script>
</head>
<body>
<!-- A√±adir el mismo fondo que home.html -->
<div class="background-container">
    <div class="gradient-bg"></div>
    <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
        <div class="shape shape-5"></div>
    </div>
</div>

<div class="container" style="padding-top:2rem;">
    <header class="header">
        <div class="logo">
            <h1>easySQL</h1>
            <span class="tagline">Editar Empresa</span>
        </div>
        <nav class="nav">
            <a href="home.html" class="nav-btn">Inicio</a>
        </nav>
    </header>
    <main>
        <h2 class="hero-title" style="font-size:2rem;margin:1.5rem 0;">Editar Datos Importados</h2>
        <p style="font-size:.7rem;opacity:.7;margin-top:-.5rem;margin-bottom:1.5rem;">
            No puedes modificar nombre, logo ni contrase√±a maestra.
        </p>
        <!-- Cambiar a grid de 2 columnas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Nuevo card para mostrar logo y nombre -->
            <div class="esql-card">
                <h4>Identidad Empresa</h4>
                <small>Logo y nombre (solo lectura)</small>
                <div style="text-align: center; margin: 1rem 0;">
                    <div id="logoPreview" style="width: 80px; height: 80px; margin: 0 auto 1rem; border-radius: 12px; background: rgba(0,204,255,0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(0,204,255,0.3);">
                        <span style="font-size: 2rem;">üè¢</span>
                    </div>
                    <input id="impNombre" type="text" disabled style="text-align: center; font-weight: 600; background: rgba(255,255,255,0.03);">
                </div>
            </div>
            <div class="esql-card">
                <h4>Descripci√≥n</h4>
                <small>Informaci√≥n de la empresa</small>
                <textarea id="impDescripcion" maxlength="500" style="min-height: 120px;"></textarea>
                <div class="char-counter" id="impDescCounter">0 / 500</div>
            </div>
            <div class="esql-card">
                <h4>Desarrolladores</h4>
                <small>Editar usuarios y contrase√±as (m√≠nimo 1 requerido)</small>
                <div id="impDevList" class="role-list"></div>
                <button type="button" class="add-btn" id="impAddDev">+ A√±adir Dev</button>
            </div>
            <div class="esql-card">
                <h4>Administradores</h4>
                <small>Editar usuarios y contrase√±as</small>
                <div id="impAdminList" class="role-list"></div>
                <button type="button" class="add-btn" id="impAddAdmin">+ A√±adir Admin</button>
            </div>
            <div class="esql-card">
                <h4>Credenciales Supabase (Opcional)</h4>
                <small>Para modo online con base de datos remota</small>
                <input id="impSupabaseUrl" type="url" placeholder="https://tu-proyecto.supabase.co" maxlength="200">
                <input id="impSupabaseKey" type="text" placeholder="Clave an√≥nima de Supabase" maxlength="500">
                <div class="warning-note" style="margin-top:1rem;">
                    Si se completan, se habilitar√° el modo online. Opcional para uso local √∫nicamente.
                </div>
            </div>
        </div>
        <div class="download-area" style="text-align:right; margin-top: 2rem;">
            <button id="downloadEditedImportedBtn" class="generate-btn" type="button">
                Descargar nuevo .easySQL
            </button>
        </div>
    </main>
    <footer class="footer"><p>&copy; 2024 easySQL.</p></footer>
</div>

<script>
let importedRaw = sessionStorage.getItem('importedData');
if (!importedRaw){
    alert('No hay datos importados. Regresando.');
    window.location.href='home.html';
}
let importedData = null;
try{
    importedData = JSON.parse(importedRaw);
}catch(e){
    alert('Datos corruptos.'); window.location.href='home.html';
}

const impNombre=document.getElementById('impNombre');
const impDescripcion=document.getElementById('impDescripcion');
const impDescCounter=document.getElementById('impDescCounter');
const devList=document.getElementById('impDevList');
const adminList=document.getElementById('impAdminList');
const impSupabaseUrl=document.getElementById('impSupabaseUrl');
const impSupabaseKey=document.getElementById('impSupabaseKey');

function addRow(container, user='', pass=''){
    const row=document.createElement('div');
    row.className='role-row';
    row.innerHTML=`<input type="text" placeholder="usuario" maxlength="32" value="${user}">
    <input type="password" placeholder="contrase√±a" maxlength="64" value="${pass}">
    <button type="button" class="role-delete-btn" title="Eliminar">‚úï</button>`;
    const deleteBtn = row.querySelector('button');
    deleteBtn.onclick=()=>{
        // Prevenir borrar si es el √∫ltimo dev
        if (container === devList && devList.children.length <= 1) {
            alert('Debe existir al menos un desarrollador');
            return;
        }
        row.remove();
    };
    container.appendChild(row);
}

function loadData(){
    if (!importedData) return;
    impNombre.value = importedData.nombreEmpresa||'';
    impDescripcion.value = importedData.descripcion||'';
    impDescCounter.textContent = (importedData.descripcion||'').length + ' / 500';
    
    // Cargar logo si existe
    if (importedData.logoB64) {
        const logoPreview = document.getElementById('logoPreview');
        logoPreview.innerHTML = `<img src="${importedData.logoB64}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;
    }
    
    devList.innerHTML=''; adminList.innerHTML='';
    (importedData.devUsers||[]).forEach(u=> addRow(devList,u.user,u.pass));
    (importedData.adminUsers||[]).forEach(u=> addRow(adminList,u.user,u.pass));
    
    // Asegurar al menos un dev
    if (devList.children.length === 0) {
        addRow(devList);
    }
    
    // Cargar credenciales Supabase si existen
    if (importedData.supabaseCredentials) {
        impSupabaseUrl.value = importedData.supabaseCredentials.SUPABASE_URL || '';
        impSupabaseKey.value = importedData.supabaseCredentials.SUPABASE_KEY || '';
    }
}
loadData();

document.getElementById('impAddDev').addEventListener('click', ()=> addRow(devList));
document.getElementById('impAddAdmin').addEventListener('click', ()=> addRow(adminList));
impDescripcion.addEventListener('input', e=>{
    impDescCounter.textContent = e.target.value.length + ' / 500';
});

function buildAcceso(devs, admins){
    let out='*dev\n';
    devs.forEach(d=>{out+='-'+d.user+'\n+'+d.pass+'\n';});
    out+='*admin\n';
    admins.forEach(a=>{out+='-'+a.user+'\n+'+a.pass+'\n';});
    out+='*consultor\n';
    return out;
}
function buildEmpresa(nombre, descripcion){
    return `*nombre\n${nombre}\n*descripcion\n${descripcion}\n`;
}

document.getElementById('downloadEditedImportedBtn').addEventListener('click', async ()=>{
    try{
        const devUsers=[...devList.querySelectorAll('.role-row')].map(r=>{
            const [u,p]=r.querySelectorAll('input'); return {user:u.value.trim(), pass:p.value};
        }).filter(x=>x.user&&x.pass);
        const adminUsers=[...adminList.querySelectorAll('.role-row')].map(r=>{
            const [u,p]=r.querySelectorAll('input'); return {user:u.value.trim(), pass:p.value};
        }).filter(x=>x.user&&x.pass);
        const acceso=buildAcceso(devUsers, adminUsers);
        const empresa=buildEmpresa(importedData.nombreEmpresa, impDescripcion.value.trim().slice(0,500));
        const files=[
            {name:'ACCESO.asql', blob:new Blob([acceso], {type:'text/plain'})},
            {name:'EMPRESA.bsql', blob:new Blob([empresa], {type:'text/plain'})}
        ];
        if (importedData.logoB64){
            const resp = await fetch(importedData.logoB64);
            const logoBlob = await resp.blob();
            files.push({name:'logo.png', blob:logoBlob});
        }
        
        // A√±adir credenciales Supabase actualizadas si est√°n presentes
        const supabaseUrl = impSupabaseUrl.value.trim();
        const supabaseKey = impSupabaseKey.value.trim();
        if (supabaseUrl && supabaseKey) {
            const supabaseConfig = {
                SUPABASE_URL: supabaseUrl,
                SUPABASE_KEY: supabaseKey
            };
            files.push({
                name: 'EMPRESA.ssql',
                blob: new Blob([JSON.stringify(supabaseConfig, null, 2)], {type: 'application/json'})
            });
        }
        
        if (typeof packEasysqlWeb!=='function'){
            await new Promise(r=>window.addEventListener('packEasysqlReady', r, {once:true}));
        }
        const blob = await packEasysqlWeb(files, importedData.masterPass, ()=>{});
        const a=document.createElement('a');
        a.download=(importedData.nombreEmpresa.replace(/\s+/g,'_')||'easySQL')+'.easysql';
        a.href=URL.createObjectURL(blob);
        document.body.appendChild(a); a.click();
        URL.revokeObjectURL(a.href); a.remove();
        window.location.href='easySQL.html';
    }catch(e){
        alert('Error: '+e.message);
    }
});
</script>
</body>
</html>
